<?xml version="1.0"?>
<odoo>
  <data>
    <!-- zammad_imports list -->
    <record id="zammad_imports_tree" model="ir.ui.view">
      <field name="name">colpari.zammad_imports.tree</field>
      <field name="model">colpari.activity_value_import_zammad</field>
      <field name="groups_id" eval="[(4, ref('colpari_services.group_colpari_user'))]"/>      
      <field name="arch" type="xml">
        <tree string="Zammad imports" sample="1"
          decoration-danger="last_run_state == 'fail'"
          decoration-warning="last_run_state == 'warn'" 
        >
          <field name="name" />
          <field name="project_id" />
          <field name="last_run_state" />
          <field name="zammad_url" />
          <!-- <field name="auth_token" /> -->
          <field name="action_type" />
          <field name="action_unit" />
          <field name="zammad_object_type" />
          <field name="zammad_attribute_type" />
          <field name="next_import_range_start" />
          <field name="auto_execute" />
          <field name="auto_accounting" />
          <button name="executeThis" string="Execute" type="object" class="oe_highlight"/>
          <!-- <field name="last_imported_time" readonly="True" /> -->
          <!-- <field name="runs" readonly="True" /> -->
        </tree>
      </field>
    </record>

    <!-- zammad_imports form -->
    <record id="zammad_imports_form" model="ir.ui.view">
      <field name="name">colpari.zammad_imports.form</field>
      <field name="model">colpari.activity_value_import_zammad</field>
      <field name="groups_id" eval="[(4, ref('colpari_services.group_colpari_user'))]"/>      
      <field name="arch" type="xml">
        <form>
          <sheet>
            <h2><field name="name"/> (Zammad import)</h2>
            <group>
              <field name="name" />
              <field name="last_run_state" decoration-danger="last_run_state == 'fail'" decoration-warning="last_run_state == 'warn'" />
              <field name="project_id" />
              <field name="zammad_url" />
              <field name="auth_token" password="True" />
              <field name="zammad_object_type" />
              <field name="zammad_attribute_type" />
              <field name="action_type" />
              <field name="action_unit" />
              <field name="project_accounting_interval" />
              <field name="query_range_start_mode" />
              <field name="query_range_end_mode" />
              <field name="next_import_range_start" />
              <field name="auto_execute" />
              <field name="auto_accounting" />
              <!-- <field name="last_imported_time" readonly="True" /> -->
              <button name="executeThis" string="Execute this import now" type="object" class="oe_highlight"/>
            </group>
            <h3>Runs:</h3>
            <field name="runs" readonly="True" />
          </sheet>
        </form>
      </field>
    </record>


    <!-- action to run zammad imports -->
    <record model="ir.actions.server" id="zammad_imports_run">
      <field name="name">Run Zammad import(s)</field>
      <field name="model_id" ref="model_colpari_activity_value_import_zammad" />
      <field name="binding_model_id" ref="model_colpari_activity_value_import_zammad"/>
      <field name="state">code</field>
      <field name="code">
log("m={}, r={}, rs={}".format(model, record, records), level='info')
records.execute()
      </field>
    </record>


    <!-- action for zammad_imports list-->
    <record model="ir.actions.act_window" id="act_zammad_imports_window">
      <field name="name">colpari zammad imports</field>
      <field name="res_model">colpari.activity_value_import_zammad</field>
      <field name="view_mode">tree,kanban,form</field>
    </record>

    <!-- action for auto-scheduled imports FIXME: move to separate place / base class -->
    <record id="ir_cron_colpari_autoimports" model="ir.cron">
      <field name="name">Execute automatic imports</field>
      <field name="model_id" ref="model_colpari_activity_value_import_zammad"/>
      <field name="state">code</field>
      <field name="code">model.executeAllAutoImports()</field>
      <field name="interval_number">2</field>
      <field name="interval_type">minutes</field>
      <field name="numbercall">-1</field>
      <!-- <field name="nextcall" eval="(DateTime.now().replace(hour=3, minute=0) + timedelta(days=1)).strftime('%Y-%m-%d %H:%M:%S')" /> -->
    </record>    
  </data>    
</odoo>